# UART 模块设计文档

## 1. 模块简介

该 UART 设计旨在与行业标准的 16550A UART 保持大致兼容性，但存在一些细微的差异。


## 2. 整体架构与模块划分

```
          +-----------+      +-------------+                 +-----------+
          |           |      |   Divisor   |                 |   Baud    |
          |           |<====>|  Registers  |================>| Generator |
          |           |      +-------------+                 |   Logic   |
          |           |                                      +-----------+
          |           |                                            |
          |           |                                            +------------+
          |           |      +------------+                        |            |
          |           |      |    Line    |<---------------------------------------+
          |           |<=====|   Status   |                        |            |  |
          |           |      |  Register  |<-----------------------------+      |  |
          |           |      +------------+                        |     |      |  |
          |           |                                            |     |      |  |
          |           |      +------------+                        |     |      v  |
          |           |      |    Line    |                        |     |   +----------+
          |           |<====>|   Control  |-----------------+--------------->| Receiver |
          |           |      |  Register  |                 |      |     |   |   Logic  |
          |           |      +------------+                 |      |     |   +----------+
          |           |                                     |      |     |   
          |           |                 +------------+      |      |     |  +------------+          
          |           |                 |  Receiver  |      |      |     |  |  Receiver  |   RXD
	  |           |<================|    FIFO    |<=====================|   Shift    |<-------
          |           |                 +------------+      |      |     |  |  Register  |
          |           |                        ^            |      |     |  +------------+
          |           |                        |            |      |     +---------+
          |           |                        |            |      |               |
          |           |                        |            |      +----------+    |
          |           |      +------------+    |            |                 |    |
          |           |      |    FIFO    |    |            |                 v    |
   APB    |           |=====>|   Control  |----|            |            +---------------+              
  Signals |    APB    |      |  Register  |    |            +----------->|  Transmitter  |
<---------|    bus    |      +------------+    |                         |     Logic     |
          | Interface |                        |                         +---------------+
          |           |                        |                                 |
          |           |                        v                                 v
          |           |                 +---------------+                +---------------+
          |           |                 |  Transmitter  |                |  Transmitter  |   TXD
          |           |================>|     FIFO      |===============>|     Shift     |-------->
          |           |                 +---------------+                |    Register   |
          |           |                                                  +---------------+
          |           |      +-------------+
          |           |      |  Interrupt  |                           +-------------+
          |           |<=====|      ID     |<==========================|             |
          |           |      |   Register  |                           |             |
          |           |      +-------------+                           |  Interrupt  |   IRQ
          |           |                                                |    Logic    |-------->
          |           |      +-------------+                           |             |
          |           |      |  Interrupt  |                           |             |
          |           |<====>|    Enable   |==========================>|             |
          |           |      |   Register  |                           +-------------+
          |           |      +-------------+
          |           |
          |           |      +------------+                            +-----------+   nRTS
          |           |      |   Modem    |                            |           |---------->
          |           |<=====|   Status   |<===========================|           |   nCTS
          |           |      |  Register  |                            |           |<----------
          |           |      +------------+                            |   Modem   |   nDTR
          |           |                                                |  Signals  |---------->
          |           |      +------------+                            |   Logic   |   nDSR
          |           |      |   Modem    |                            |           |<----------
          |           |=====>|  Control   |===========================>|           |   nDCD
          |           |      |  Register  |                            |           |<----------
          |           |      +------------+                            |           |   nRI
          |           |                                                |           |<----------
          +-----------+                                                +-----------+
```

## 3. 接口信号描述

### 3.1 APB 接口信号

| 信号名称       | 位宽 | 方向 | 描述 |
|----------------|:----:|:-----:|:---|
| `PCLK`         | 1    | 输入 | **APB总线时钟**。|
| `PRESETn`      | 1    | 输入 | **低电平有效异步复位**。|
| `PADDR`        | 32   | 输入 | **APB地址字段**。|
| `PSEL`         | 1    | 输入 | **APB外设选择**。|
| `PWRITE`       | 1    | 输入 | **APB写使能**。|
| `PENABLE`      | 1    | 输入 | **APB外设使能**。|
| `PWDATA`       | 32   | 输入 | **APB写数据字段**。|
| `PRDATA`       | 32   | 输出 | **APB读数据字段**。|
| `PREADY`       | 1    | 输出 | **APB外设就绪**。|
| `PSLVERR`      | 1    | 输出 | **APB从设备错误**。|

### 3.2 UART 功能信号

| 信号名称       | 位宽 | 方向 | 描述 |
|----------------|:----:|:-----:|:---|
| `TXD`         | 1    | 输出 | **串行传输数据输出**。|
| `RXD`         | 1    | 输入 | **串行接收数据输入**。|
| `nCTS`        | 1    | 输入 | **允许发送（低电平有效）**。|
| `nDSR`        | 1    | 输入 | **数据设备就绪（低电平有效）**。|
| `nDCD`        | 1    | 输入 | **数据载波检测（低电平有效）**。|
| `nRI`         | 1    | 输入 | **振铃指示（低电平有效）**。|
| `nRTS`        | 1    | 输出 | **请求发送（低电平有效）**。|
| `nDTR`        | 1    | 输出 | **数据终端就绪（低电平有效）**。|
| `nOUT1`       | 1    | 输出 | **通用输出信号1（低电平有效）**。|
| `nOUT2`       | 1    | 输出 | **通用输出信号2（低电平有效）**。|

### 3.3 其他信号

| 信号名称       | 位宽 | 方向 | 描述 |
|----------------|:----:|:-----:|:---|
| `baud_o`       | 1    | 输出 | **波特率分频器输出**。|
| `IRQ`          | 1    | 输出 | **中断输出**。|


## 4. 寄存器描述

### 4.1 寄存器摘要

原始的16550 8位寄存器位字段被保留，但被映射到32位的地址槽中。未使用的24个最高有效位在读取时会返回0。

| 寄存器名称     | 偏移地址 | 位宽 | 访问权限 | 描述 |
|----------------|:--------:|:----:|:--------:|:---|
| `RXD`          | 0x0      | 8    | 只读 | **接收FIFO输出寄存器**。|
| `TXD`          | 0x0      | 8    | 只写 | **发送FIFO输入寄存器**。|
| `IER`          | 0x4      | 8    | 读写 | **中断使能寄存器**。|
| `IIR`          | 0x8      | 8    | 只读 | **中断识别寄存器**。|
| `FCR`          | 0x8      | 8    | 只写 | **FIFO控制寄存器**。|
| `LCR`          | 0xc      | 8    | 读写 | **线路控制寄存器**。|
| `MCR`          | 0x10     | 8    | 读写 | **调制解调器控制寄存器**。|
| `LSR`          | 0x14     | 8    | 只读 | **线路状态寄存器**。|
| `MSR`          | 0x18     | 8    | 只读 | **调制解调器状态寄存器**。|
| `DIV1`         | 0x1c     | 8    | 读写 | **波特率除数低字节寄存器**。|
| `DIV2`         | 0x20     | 8    | 读写 | **波特率除数高字节寄存器**。|

### 4.2 详细寄存器描述

#### 4.2.1 TXD, RXD - 数据缓存寄存器

| 寄存器名称 | 位域 | 访问权限 | 描述 |
|-----|:---:|:---:|:---|
| `TXD` | [7:0] | 只写 | **写入发送FIFO底部**。|
| `RXD` | [7:0] | 只读 | **从接收FIFO顶部读取**。|

复位值未定义

#### 4.2.2 IER - 中断使能寄存器

该寄存器可以实现UART中的各种中断。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [0] | 读写 | **接收数据中断使能**。|
| [1] | 读写 | **传输保持寄存器空中断使能**。|
| [2] | 读写 | **接收线路状态中断使能**。|
| [3] | 读写 | **调制解调器状态中断使能**。|
| [7:4] | 读写 | **预留位**。总是读为0。 |

复位值：0x0

对这些中断使能位中的任意一个写入逻辑'1'将使中断启用，写入逻辑'0'将使中断禁用。复位后所有中断均被禁用。

#### 4.2.3 IIR - 中断识别寄存器

这个只读寄存器用于识别一个中断是否挂起，如果挂起，是哪个中断。
如果没有中断等待，寄存器的0位将作为逻辑'1'读回，否则UART有中断等待服务。在寄存器的[3:0]位返回的有效代码描述如下表：

| 编码 | 优先级 | 中断类型 | 中断源 | 中断复位控制方式 |
|-----|:---:|:---|:---|:---|
| 0x1 | - | **无中断** | - | - |
| 0x6 | 1st | **接收线路状态中断** | 发生奇偶校验错、溢出错误、帧错误，或检测到线路中断 | **读取线路状态寄存器（LSR）**。 |
| 0x4 | 2nd | **接收数据可用中断** | RX FIFO中的数据量达到FCR寄存器设定的触发阈值。 | **当RX FIFO中的数据量低于触发阈值时**。 |
| 0xC | 2nd | **接收超时中断** | 接收FIFO中至少有一个字符，但在至少4个字符周期内，既没有新字符被接收到FIFO，也没有字符从FIFO中被读取。 | **从接收数据寄存器（RXD）执行一次读操作**。 |
| 0x2 | 3rd | **传输器空中断** | 发送FIFO和发送移位寄存器均为空。 | **读取本寄存器（IIR）或向发送数据寄存器（TXD）写入数据**。 |
| 0x0 | 4th | **调制解调器状态中断** | 调制解调器输入信号（CTS、DSR、RI、DCD）之一发生状态变化。 | **读取调制解调器状态寄存器（MSR）**。 |

[7:4]位未被使用，总是被读回0xC

复位值：0xC1

#### 4.2.4 FCR - FIFO 控制寄存器

FIFO控制寄存器是一个只写的寄存器，它允许TX FIFO和RX FIFO被清空。它还设置了RX FIFO阈值的水平。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [0] | 只写 | **保留位**。 |
| [1] | 只写 | **刷新接收FIFO**。设置为逻辑'1'时，将清空RX FIFO的内容，但不影响正在接收过程中的字符。 |
| [2] | 只写 | **刷新发送FIFO**。设置为逻辑'1'时，将清空TX FIFO的内容，但不影响正在发送过程中的字符。|
| [5:3] | 只写 | **保留位**。 |
| [7:6] | 只写 | **设置RX FIFO中断触发阈值**。<br> • `00` – **1个字符**<br> • `01` – **4个字符**<br> • `10` – **8个字符**<br> • `11` – **14个字符** |

复位值：0x0

#### 4.2.5 LCR - 线路控制寄存器

LCR控制UART发送和接收的串行字符的格式。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [1:0] | 读写 | **定义每字符的数据位数**。<br> • `00` – **5位**<br> • `01` – **6位**<br> • `10` – **7位**<br> • `11` – **8位** |
| [2] | 读写 | **选择发送的停止位数**。<br> • `0` – **1个停止位**<br> • `1` – 对于8、7、6位字符为**2个停止位**；对于5位字符为**1.5个停止位**<br> **注意**：接收路径仅检查1个停止位。 |
| [3] | 读写 | **奇偶校验使能**。<br> • `0` – **无奇偶校验**<br> • `1` – **启用奇偶校验** |
| [4] | 读写 | **偶校验选择**。<br> • `0` – **奇校验**（校验位确保整个字符中1的总数为奇数）<br> • `1` – **偶校验**（校验位确保整个字符中1的总数为偶数） |
| [5] | 读写 | **固定校验位选择**。<br> • `0` – **禁用固定校验**<br> • `1` – **启用固定校验**，此时将位4的反相信号作为校验位发送 |
| [6] | 读写 | **线路中断控制位**。<br> • `0` – **禁用线路中断**<br> • `1` – **发送线路中断**，强制TX串行数据线输出为逻辑‘0’，以指示线路中断状态 |
| [7] | 读写 | **保留位**。 |

复位值：0x3

#### 4.2.6 MCR - 调制解调器控制寄存器

MCR寄存器为调制解调器的控制线提供了软件接口，并允许UART的环回模式被启用。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [0] | 读写 | **数据终端就绪（DTR）**。输出值为写入值的取反。 |
| [1] | 读写 | **请求发送（RTS）**。输出值为写入值的取反。 |
| [2] | 读写 | **Out1信号**。**在环回模式下**，此信号内部连接到`RI`输入信号。 |
| [3] | 读写 | **Out2信号**。**在环回模式下**，此信号内部连接到`DCD`输入信号。 |
| [4] | 读写 | **环回模式**。<br> • `0` – **正常工作模式**<br> • `1` – **环回模式启用**<br>在环回模式下，模块内部建立以下连接：<br> • TXD → RXD<br> • DTR → DSR<br> • RTS → CTS<br> • OUT1 → RI<br> • OUT2 → DCD |
| [7:5] | 读写 | **保留位**。 |

复位值：0x0

#### 4.2.7 LSR - 线路状态寄存器

LSR提供来自UART接收和发送通道的状态信息。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [0] | 只读 | **数据就绪（DR）**。<br> • `0` – RX FIFO中无数据<br> • `1` – RX FIFO中至少有一个字符 |
| [1] | 只读 | **溢出错误（OE）**。<br>当RX FIFO已满，又收到新字符时，此位置1。读取LSR寄存器时清除此位。 |
| [2] | 只读 | **奇偶校验错误（PE）**。<br> • `1` – RX FIFO顶部的字符接收时存在奇偶校验错误<br> • `0` – RX FIFO顶部的字符无奇偶校验错误<br>读取LSR寄存器时清除此位。 |
| [3] | 只读 | **帧错误（FE）**。<br> • `1` – RX FIFO顶部的字符存在帧错误<br> • `0` – RX FIFO顶部的字符无帧错误<br>读取LSR寄存器时清除此位。 |
| [4] | 只读 | **线路中断指示（BI）**。<br>当`RXD`输入线保持逻辑'0'至少一个完整的字符周期时，检测到线路中断。此时一个全零字符被载入RX FIFO，且此位置1。读取LSR寄存器时清除此位。 |
| [5] | 只读 | **发送FIFO空**。<br> • `1` – TX FIFO为空 - 产生TX空中断<br> • `0` – TX FIFO中至少有一个字符<br>当向TX FIFO写入一个字符时，此位被清除。 |
| [6] | 只读 | **发送器空**。<br> • `1` – **发送移位寄存器**和**TX FIFO**均为空<br> • `0` – TX FIFO中至少有一个字符，或者发送移位寄存器正忙<br>当向发送FIFO写入一个字符时，此位被清除。 |
| [7] | 只读 | **FIFO错误**。<br> • `1` – RX FIFO中至少存储了一个存在奇偶校验错误、帧错误或线路中断指示的字符<br> • `0` – RX FIFO中无错误字符<br>读取LSR寄存器时清除此位。 |

复位值：0x60

#### 4.2.8 MSR - 调制解调器状态寄存器

MSR提供调制解调器输入线路的状态信息，在回环模式下改变功能。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [0] | 只读 | **允许发送信号变化（DCTS）**。若`CTS`输入发生改变，则置1。 |
| [1] | 只读 | **数据设备就绪信号变化（DDSR）**。若`DSR`输入发生改变，则置1。 |
| [2] | 只读 | **振铃指示信号后沿（TERI）**。若`RI`输入发生从'1'到'0'的转换，则置1。 |
| [3] | 只读 | **数据载波检测信号变化（DDCD）**。若`DCD`输入发生改变，则置1。 |
| [4] | 只读 | **`CTS`输入信号的取反**。或环回模式下的RTS。|
| [5] | 只读 | **`DSR`输入信号的取反**。或环回模式下的DTR。|
| [6] | 只读 | **`RI`输入信号的取反**。或环回模式下的Out1。|
| [7] | 只读 | **`DCD`输入信号的取反**。或环回模式下的Out2。|

复位值：0x0

#### 4.2.9 DIV1 - 除数低字节

UART波特率分频器由一个16位计数器实现，它通过对APB总线时钟（PCLK）进行分频，最终得到一个频率为16倍串行数据速率的时钟。计数器的除数通过两个8位寄存器DIV1和DIV2加载。读取这两个寄存器将返回预先设置的波特率分频系数，而非分频计数器的当前值。当DIV1寄存器被写入时，计数器被启动，或者重新启动。

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [7:0] | 读写 | **波特率除数低字节**。16位波特率除数的低8位。 |

复位值：0x0

#### 4.2.10 DIV2 - 除数高字节

| 位域 | 访问权限 | 描述 |
|-----|:---:|:---|
| [7:0] | 读写 | **波特率除数高字节**。16位波特率除数的高8位。 |

复位值：0x0


# 验证目标

只要验证uart相关的功能，其他验证，例如波形、接口等，不需要出现


# 其他

所有的文档和注释都用中文编写


# bug分析

在bug分析时，请参考源码：uart/uart/目录下的*.sv文件
